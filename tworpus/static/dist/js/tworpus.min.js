tworpusApp.config(["$routeProvider",function(a){a.when("/createcorpus",{templateUrl:"/static/views/create_corpus_content.html",controller:"CreateCorpusController"}).when("/corpora",{templateUrl:"/static/views/corpora.html",controller:"CorporaController"}).when("/settings",{templateUrl:"/static/views/settings.html",controller:"SettingsController"}).otherwise({redirectTo:"/createcorpus"})}]).directive("twCreateCorpus",function(){return{restrict:"A",link:function(a){a.$watch("availableConverters",function(a){a.length>0&&setTimeout(function(){var a=$("#converters label");a.tooltip()},100)})}}}).controller("CreateCorpusController",["$scope","$rootScope","$http","urls","corpusCreationService","notify",function(a,b,c,d,e,f){a.corpus={};var g=function(b){b||(b={}),b.endDate||(b.endDate=moment().add("days",1).toDate()),b.startDate||(b.startDate=moment().subtract("days",10).toDate()),b.numTweets||(b.numTweets=20),b.numMinWords||(b.numMinWords=0),b.numMinChars||(b.numMinChars=0),b.language||(b.language="en"),b.title||(b.title=""),a.corpus.endDate=moment(b.endDate).toDate(),a.corpus.startDate=moment(b.startDate).toDate(),a.corpus.language=b.language,$("#input_slider_num_tweets").attr("data-slider-value",b.numTweets),a.corpus.numTweets=b.numTweets,$("#input_slider_min_chars").attr("data-slider-value",b.numMinWords),a.corpus.numMinWords=b.numMinWords,$("#input_slider_min_words").attr("data-slider-value",b.numMinChars),a.corpus.numMinChars=b.numMinChars,a.corpus.title=b.title};g(JSON.parse(localStorage.getItem("formValues"))),a.languages=[{name:"German",value:"de"},{name:"English",value:"en"},{name:"Spanish",value:"es"},{name:"French",value:"fr"},{name:"Italian",value:"it"},{name:"Dutch",value:"nl"},{name:"Portuguese",value:"pt"},{name:"Turkish",value:"tr"}],a.availableConverters={},c.get(d.converters).success(function(b){a.availableConverters=b}),a.startCreateCorpus=function(){var c=$("form").get(0).checkValidity();if(c===!0){var d=[],h=$("form").find("#converters label.active input[type='checkbox']");angular.forEach(h,function(a){d.push($(a).val())}),a.corpus.converters=d,e.startCorpusCreation(a.corpus).success(function(c,d){switch(d){case 206:f("Corpus <b>"+a.corpus.title+" </b>is being created, but there are not sufficient tweets available.","info");break;default:f("Corpus <b>"+a.corpus.title+" </b>is being created.")}b.$emit("corpus:create:start"),g()}).error(function(a,b){switch(b){case 444:f("No tweets found to fetch. Try to be less specific.","error");break;default:f("Failed to fetch tweets.","error")}})}};var h=function(){localStorage.setItem("formValues",JSON.stringify({endDate:a.corpus.endDate,startDate:a.corpus.startDate,language:a.corpus.language,numMinChars:a.corpus.numMinChars,numMinWords:a.corpus.numMinWords,numTweets:a.corpus.numTweets,title:a.corpus.title}))};a.$on("$destroy",function(){h()}),window.onbeforeunload=function(){h()},a.resetForm=function(){g()}}]).directive("ngBootstrapSlider",function(){return{restrict:"A",scope:{ngModel:"="},require:"ngModel",link:function(a,b,c){a.ngModel=parseInt(c.sliderValue)||0;var d=$(b).slider({value:0});a.slider=d,d.on("slide",function(){var b=$(this).val();a.ngModel=parseInt(b),a.$apply()})},controller:function(a){a.$watch("ngModel",function(b){a.slider.slider("setValue",b)})}}}).directive("twDate",function(){return{restrict:"A",scope:{ngModel:"=",minDate:"=",maxDate:"="},require:"ngModel",link:function(a,b){var c=new Pikaday({field:b[0],bound:!1,onSelect:function(b){a.ngModel=b||new Date,a.$apply()}});a.$watch("ngModel",function(a){c.setDate(a,!0)}),a.$watch("minDate",function(b){c.setMinDate(b),c.setDate(a.ngModel,!0)}),a.$watch("maxDate",function(b){c.setMaxDate(b),c.setDate(a.ngModel,!0)})}}}).controller("twDateRangeController",["$scope",function(a){a.$watch("corpus.startDate",function(b){a.corpus&&(b>a.corpus.endDate&&(a.corpus.startDate=a.corpus.endDate),a.corpus.endDate.minDate=b)}),a.$watch("corpus.endDate",function(b){a.corpus&&(b<a.corpus.startDate&&(a.corpus.endDate=a.corpus.startDate),a.corpus.startDate.maxDate=b)})}]);var pieChartConfig={width:250,height:250,innerRadius:80,colors:["#379A8C","#ED5564","#EBEBEB"]},createPieChart=function(a){return d3.select(a.get(0)).append("svg").attr("width",pieChartConfig.width).attr("height",pieChartConfig.height).append("svg:g").attr("transform","translate("+pieChartConfig.width/2+","+pieChartConfig.height/2+")")},updatePieChart=function(a,b){function c(a){var b=d3.interpolate(this._current,a);return this._current=b(0),function(a){return g(b(a))}}function d(a){return a.innerRadius=0,a.outerRadius=e,"translate("+g.centroid(a)+")"}var e=Math.min(pieChartConfig.width,pieChartConfig.height)/2,f=d3.layout.pie().startAngle(1.1*Math.PI).endAngle(3.1*Math.PI).sort(null).value(function(a){return a}),g=d3.svg.arc().outerRadius(e).innerRadius(e-pieChartConfig.innerRadius),h=a.selectAll("path").data(f(b)),i=a.selectAll("text").data(f(b));h.enter().append("path").attr("fill",function(a,b){return pieChartConfig.colors[b]}).attr("d",g).each(function(a){this._current=a}),i.enter().append("text").attr("transform",d).attr("text-anchor","middle").attr("font-weight","bold"),h.transition().attrTween("d",c),i.transition().attr("transform",d),i.text(function(a,c){return 0==b[c]?null:b[c]}),h.exit().remove(),i.exit().remove()},updateCorpusView=function(a,b){var c=b.find(".corpus-view-details-fromTo");c.text(moment(a.startDate).format("MM/DD/YYYY")+" - "+moment(a.endDate).format("MM/DD/YYYY"));var d=b.find(".corpus-view-details"),e=b.find(".corpus-view-buttonbar");b.hover(function(){d.addClass("move-in"),e.addClass("move-in")},function(){d.removeClass("move-in"),e.removeClass("move-in")})};tworpusApp.controller("CorporaController",["$scope","$http","corpusCreations","urls","notify","$filter",function(a,b,c,d,e,f){a.corpusCreations=c.corpusCreationProcesses,a.remove=c.remove,a.download=function(a){var b=f("indexOfCorpusid")(c.corpusCreationProcesses,a),e=c.corpusCreationProcesses[b];e.working||(window.location=d.downloadCorpus+"?id="+a)},a.recreate=function(a){var g=f("indexOfCorpusid")(c.corpusCreationProcesses,a),h=c.corpusCreationProcesses[g];h.working||b.post(d.recreateCorpus+"?id="+a).success(function(){e("Corpus is being recreated"),c.fetch(a).success(function(){c.longPoll()})})},c.fetchAll()}]).directive("twCreateCorporaView",["corpusCreations","$filter",function(a){return{restrict:"A",scope:{ngModel:"="},require:"ngModel",link:function(b,c){var d=b.ngModel;if(!d)return void $(c).parent().remove();var e=$(c),f=e.find(".corpus-view-details-tweets-fetched"),g=e.find(".corpus-view-details-tweets-failed"),h=e.find(".corpus-view-buttonbar-renew"),i=e.find(".corpus-view-buttonbar-export"),j=e.find(".corpus-view-title");updateCorpusView(d,e);var k=createPieChart(c);updatePieChart(k,[d.tweetsFetched,d.tweetsFailed,d.numTweets-d.tweetsFetched-d.tweetsFailed]),b.processes=a.corpusCreationProcesses,b.$watch("ngModel",function(a){a.progress<=100&&(f.text("Tweets fetched: "+a.tweetsFetched),g.text("Tweets failed: "+a.tweetsFailed),updatePieChart(k,[a.tweetsFetched,a.tweetsFailed,a.numTweets-d.tweetsFetched-d.tweetsFailed])),a.working&&!h.hasClass("disabled")&&(j.toggleClass("working"),h.toggleClass("disabled"),i.toggleClass("disabled")),!a.working&&h.hasClass("disabled")&&(j.toggleClass("working"),h.toggleClass("disabled"),i.toggleClass("disabled"))},!0)}}}]),tworpusApp.startJoyride=function(){setTimeout(function(){$("#joyRideTipContent").joyride({autostart:!0,expose:!0})},500)},$("#help").click(tworpusApp.startJoyride),localStorage.getItem("firstStart")||(localStorage.setItem("firstStart",!0),$(window).load(function(){tworpusApp.startJoyride()})),angular.module("createCorpus.services",[]).service("corpusCreationService",["$http","urls",function(a,b){this.startCorpusCreation=function(c){return c.startDateTimestamp=c.startDate,c.startDateTimestamp.setHours(0),c.startDateTimestamp.setMinutes(0),c.startDateTimestamp=c.startDateTimestamp.getTime(),c.endDateTimestamp=c.endDate,c.endDateTimestamp.setHours(0),c.endDateTimestamp.setMinutes(0),c.endDateTimestamp=c.endDateTimestamp.getTime(),a({method:"POST",url:b.startCreateCorpus,data:c})}}]),angular.module("navigation",[]).directive("twNavigation",["$location",function(a){return{restrict:"A",link:function(b,c){var d=c.attr("href").substr(1);b.$watch(function(){return a.path()},function(){d===a.path()?c.closest("li").addClass("active"):c.closest("li").removeClass("active")})}}}]).controller("NavbarController",["$scope","$http","urls",function(a,b,c){a.exit=function(){b.post(c.exit).success(function(){console.log("exit success")}).error(function(){})}}]),angular.module("notifications",[]).factory("notify",[function(){return function(a,b){b=b||"success",console.log("notifification: ",a),console.log("notifification type: ",b);var c={text:a,type:b};"info"===b?c.icon="glyphicon glyphicon-info-sign":"success"===b&&(c.icon="glyphicon glyphicon-ok-sign"),$.pnotify(c)}}]),angular.module("tworpusApp.progress",["tworpusApp.progress.services"]).directive("twCorpusProgress",[function(){return{templateUrl:"/static/views/corpus_creation_progress.html",replace:!0,scope:{twProgresses:"="},link:function(a){a.$parent.$watch("showProgressbar",function(a){a===!0?$("body").addClass("progressbar-expanded"):$("body").removeClass("progressbar-expanded")})}}}]).filter("unfinished",function(){return function(a){var b=[];return angular.forEach(a,function(a){a.completed===!1&&b.push(a)}),b}}).filter("working",function(){return function(a){var b=[];return angular.forEach(a,function(a){a.working===!0&&b.push(a)}),b}}).filter("corpusid",function(){return function(a,b){var c=null;for(var d in a){a[d].id===b&&(c=a[d]);break}return c}}).filter("indexOfCorpusid",function(){return function(a,b){var c=null;for(var d in a)if(a[d].id===b){c=d;break}return c}}).controller("ProgressController",["$scope","$rootScope","$http","$filter","corpusCreations","urls",function(a,b,c,d,e,f){a.corpusCreationProcesses=e.corpusCreationProcesses,a.showProgressbar=!1;var g=function(){e.fetchAll()};g(),b.$on("corpus:create:start",function(){a.showProgressbar=!0,e.fetchAll().success(function(){})}),a.toggleShowProgressbar=function(){a.showProgressbar=!a.showProgressbar},a.removeCorpus=function(a){e.remove(a)},a.pause=function(a){c.get(f.pauseCorpus+"?id="+a).then(function(){g()})},a.resume=function(a){c.get(f.resumeCorpus+"?id="+a).then(function(){e.fetch(a).then(e.longPoll())})};a.$watchCollection("corpusCreationProcesses",function(){var a=d("working")(e.corpusCreationProcesses);a.length>0&&e.longPoll()}),a.$watch("corpusCreationProcesses",function(){var b=d("working")(e.corpusCreationProcesses);console.log("collection changed"),0==b.length&&(console.log("collection empty"),a.showProgressbar=!1)},!0)}]),angular.module("tworpusApp.progress.services",[]).service("corpusCreations",["$http","$filter","urls","socketId","notify",function(a,b,c,d,e){var f=this;this.corpusCreationProcesses=[],this.pause=function(){};var g=!1,h=0;this.longPoll=function(){g||i()};var i=function(){g=!0;var a=b("working")(f.corpusCreationProcesses);return 0===a.length&&++h>=30?(g=!1,void(h=0)):(angular.forEach(a,function(a){f.fetch(a.id)}),void setTimeout(function(){i()},200))};this.fetch=function(d){return d=new String(d),a.get(c.session+"?id="+d).success(function(a){var c=b("indexOfCorpusid")(f.corpusCreationProcesses,a.id),d=f.corpusCreationProcesses[c];d.progress=a.progress,d.completed=a.completed,d.working=a.working,d.tweetsFetched=a.tweetsFetched,d.tweetsFailed=a.tweetsFailed})},this.fetchAll=function(){return a.get(c.sessions).success(function(a){angular.forEach(a,function(a){var c=b("indexOfCorpusid")(f.corpusCreationProcesses,a.id);null===c&&f.corpusCreationProcesses.push(a)})})},this.remove=function(d){var g=b("indexOfCorpusid")(f.corpusCreationProcesses,d),h=f.corpusCreationProcesses.splice(g,1),i=c.removeCorpus+"?corpusid="+d;h.length>0?(h=h[0],a.get(i).success(function(){e("Corpus <b>"+h.title+" </b>was successfully removed")}).error(function(){e("Corpus "+h.title+" couldn't be removed","error")})):e("Element could not be found")}}]),angular.module("tworpusApp.cache",["ngAnimate"]).controller("SettingsController",["$scope","$http","urls","notify","corpusCreations",function(a,b,c,d,e){var f=!1;e.fetchAll(),a.$watch(function(){return e.corpusCreationProcesses},function(a){f=!1;for(var b=0;b<a.length;b++)if(a[b].working===!0){f=!0;break}f?$(".btn").addClass("btn-disabled"):$(".btn").removeClass("btn-disabled")},!0),a.clearCache=function(){f||(a.showClearConfirmation=!1,b.post(c.clearCache).success(function(){d("Cache cleared"),g()}).error(function(){d("Failed to clear cache")}))};var g=function(){b.get(c.cacheStatus).success(function(b){a.numFiles=b.numFiles,a.size=b.size})};g();var h=setInterval(g,5e3);a.$on("$destroy",function(){clearInterval(h)}),a.showClearConfirmation=!1,a.displayClearConfirmation=function(){a.showClearConfirmation=f?!1:!0},a.setTweetsXml=function(a){f||b.post(c.setTweetsPerXml,{tweets_per_xml:a}).success(function(){d("Tweets/XML successfully set to "+a)}).error(function(){d("Couldn't set Tweets/XML","error")})},function(){b.get(c.getTweetsPerXml).success(function(b){a.tweetsXml=b.tweets_per_xml})}()}]).filter("bytes",function(){return function(a,b){if(0===a)return"0 bytes";if(isNaN(parseFloat(a))||!isFinite(a))return"";"undefined"==typeof b&&(b=1);var c=["bytes","kB","MB","GB","TB","PB"],d=Math.floor(Math.log(a)/Math.log(1024));return(a/Math.pow(1024,Math.floor(d))).toFixed(b)+" "+c[d]}});